{% extends 'dashboard/base.html' %}
{% load static %}
{% block title %}Students{% endblock %}
{% block content %}
<div class="app-wrapper">

	<div class="app-content pt-3 p-md-3 p-lg-4">
		<div class="container-xl">

			<div class="d-flex justify-content-between align-items-center mb-4">
				<h1 class="app-page-title mb-0"><i class="fas fa-user-graduate me-2"></i>Students</h1>
				<div class="d-flex align-items-center gap-3">
					<form class="table-search-form row gx-2 align-items-center" method="get" action="">
						<div class="col-auto">
							<div class="input-group align-items-center">
								<span class="input-group-text border-0 bg-transparent"><i class="fas fa-search text-muted"></i></span>
								<input type="text" id="students-search" name="q" class="form-control border-0 shadow-none" placeholder="Search studentsâ€¦" aria-label="Search students" value="{{ request.GET.q }}" autocomplete="off" spellcheck="false" />
								<button type="button" class="btn btn-link px-2 clear-students-search" title="Clear" aria-label="Clear" hidden><i class="fas fa-times-circle text-muted"></i></button>
							</div>
						</div>
						<div class="col-auto">
							<button type="submit" class="btn app-btn-secondary">Search</button>
						</div>
					</form>
					<a class="btn app-btn-primary text-nowrap" href="{% url 'add_user' %}"><i class="fas fa-plus me-2"></i>Create New Student</a>
				</div>
			</div>

			<!-- Statistics Cards -->
			<div class="row g-3 mb-4">
				<div class="col-6 col-md-3">
					<div class="card shadow-sm border-0 h-100">
						<div class="card-body">
							<div class="d-flex align-items-center">
								<div class="flex-shrink-0">
									<div class="stat-icon bg-primary bg-opacity-10 text-primary rounded-circle p-3">
										<i class="fas fa-users fa-lg"></i>
									</div>
								</div>
								<div class="flex-grow-1 ms-3">
									<div class="text-muted small">Total Students</div>
									<div class="fs-4 fw-bold">{{ student_count }}</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-6 col-md-3">
					<div class="card shadow-sm border-0 h-100">
						<div class="card-body">
							<div class="d-flex align-items-center">
								<div class="flex-shrink-0">
									<div class="stat-icon bg-success bg-opacity-10 text-success rounded-circle p-3">
										<i class="fas fa-check-circle fa-lg"></i>
									</div>
								</div>
								<div class="flex-grow-1 ms-3">
									<div class="text-muted small">Enrolled</div>
									<div class="fs-4 fw-bold">{{ enrolled_students }}</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-6 col-md-3">
					<div class="card shadow-sm border-0 h-100">
						<div class="card-body">
							<div class="d-flex align-items-center">
								<div class="flex-shrink-0">
									<div class="stat-icon bg-info bg-opacity-10 text-info rounded-circle p-3">
										<i class="fas fa-user-check fa-lg"></i>
									</div>
								</div>
								<div class="flex-grow-1 ms-3">
									<div class="text-muted small">Active</div>
									<div class="fs-4 fw-bold">{{ active_students }}</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-6 col-md-3">
					<div class="card shadow-sm border-0 h-100">
						<div class="card-body">
							<div class="d-flex align-items-center">
								<div class="flex-shrink-0">
									<div class="stat-icon bg-warning bg-opacity-10 text-warning rounded-circle p-3">
										<i class="fas fa-hourglass-half fa-lg"></i>
									</div>
								</div>
								<div class="flex-grow-1 ms-3">
									<div class="text-muted small">Not Enrolled</div>
									<div class="fs-4 fw-bold">{{ student_count|add:"-"|add:enrolled_students }}</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="tab-content" id="orders-table-tab-content">
				<div class="tab-pane fade show active" id="orders-all" role="tabpanel" aria-labelledby="orders-all-tab">
					<div class="app-card app-card-orders-table shadow-sm mb-5">
						<div class="app-card-body">
							<div class="table-responsive">
								<table id="students-table" class="table app-table-hover mb-0 text-left">
									<thead>
										<tr>
											<th class="cell">Profile</th>
											<th class="cell">Student Info</th>
											<th class="cell">Contact</th>
											<th class="cell">Academic Level</th>
											<th class="cell">Enrollment Status</th>
											<th class="cell">Status</th>
											<th class="cell">Actions</th>
										</tr>
									</thead>
									<tbody>
										{% for student in students %}
										<tr>
											<td class="cell">
												{% if student.profile_picture %}
													<img src="{{ student.profile_picture.url }}" alt="{{ student.username }}" class="rounded-circle" width="40" height="40">
												{% else %}
													<div class="bg-secondary bg-opacity-10 text-secondary rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
														<i class="fas fa-user"></i>
													</div>
												{% endif %}
											</td>
											<td class="cell">
												<div class="fw-bold">{{student.first_name}} {{student.last_name}}</div>
												<div class="small text-muted"><i class="fas fa-at"></i> {{student.username}}</div>
											</td>
											<td class="cell">
												<div class="small">
													{% if student.email %}
														<i class="fas fa-envelope me-1"></i>{{ student.email|truncatewords:2 }}<br>
													{% endif %}
													{% if student.phone %}
														<i class="fas fa-phone me-1"></i>{{student.phone}}
													{% endif %}
												</div>
											</td>
											<td class="cell">
												{% if student.academic_level %}
													<span class="badge bg-info bg-opacity-10 text-info">
														<i class="fas fa-graduation-cap me-1"></i>{{student.academic_level}}
													</span>
												{% else %}
													<span class="badge bg-secondary">Not Assigned</span>
												{% endif %}
											</td>
											<td class="cell">
												{% if student.course %}
													<div class="badge bg-success bg-opacity-10 text-success">
														<i class="fas fa-check-circle me-1"></i>Enrolled
													</div>
													<div class="small text-muted mt-1">{{ student.course.title|truncatewords:3 }}</div>
												{% else %}
													<span class="badge bg-warning bg-opacity-10 text-warning">
														<i class="fas fa-exclamation-circle me-1"></i>Not Enrolled
													</span>
												{% endif %}
											</td>
											<td class="cell">
												{% if student.is_active %}
													<span class="badge bg-success"><i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>Active</span>
												{% else %}
													<span class="badge bg-secondary"><i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>Inactive</span>
												{% endif %}
											</td>
											<td class="cell">
												<a class="btn btn-sm btn-outline-primary" href="{% url 'dashboard:user_detail' student.id %}">
													<i class="fas fa-eye me-1"></i>View
												</a>
											</td>
										</tr>
										{%endfor%}

										<tr class="no-results d-none">
											<td colspan="7" class="text-center text-muted">No matching students</td>
										</tr>


									</tbody>
								</table>
							</div><!--//table-responsive-->

						</div><!--//app-card-body-->
					</div><!--//app-card-->

				</div><!--//tab-pane-->




			</div><!--//tab-content-->


		</div><!--//container-fluid-->
	</div><!--//app-content-->



</div><!--//app-wrapper-->


{% endblock %}
{% block extra_scripts %}
<script src="{% static 'dashboard/assets/plugins/popper.min.js' %}"></script>
<script src="{% static 'dashboard/assets/plugins/bootstrap/js/bootstrap.min.js' %}"></script>

<!-- Page Specific JS -->
<script src="{% static 'dashboard/assets/js/app.js' %}"></script>

<script>
	// Lightweight client-side search functionality
	document.addEventListener('DOMContentLoaded', function() {
		const searchInput = document.getElementById('students-search');
		const clearButton = document.querySelector('.clear-students-search');
		const table = document.getElementById('students-table');
		const noResultsRow = document.querySelector('.no-results');

		if (searchInput && table) {
			searchInput.addEventListener('input', function(e) {
				e.preventDefault();
				const query = this.value.toLowerCase().trim();
				clearButton.hidden = !query;

				const rows = table.querySelectorAll('tbody tr:not(.no-results)');
				let matchCount = 0;

				rows.forEach(row => {
					const text = row.textContent.toLowerCase();
					if (text.includes(query)) {
						row.style.display = '';
						matchCount++;
					} else {
						row.style.display = 'none';
					}
				});

				if (noResultsRow) {
					noResultsRow.classList.toggle('d-none', matchCount > 0);
				}
			});

			if (clearButton) {
				clearButton.addEventListener('click', function() {
					searchInput.value = '';
					searchInput.dispatchEvent(new Event('input'));
					searchInput.focus();
				});
			}

			// Prevent form submission
			const searchForm = searchInput.closest('form');
			if (searchForm) {
				searchForm.addEventListener('submit', function(e) {
					e.preventDefault();
					return false;
				});
			}
		}
	});
</script>

{% endblock %}